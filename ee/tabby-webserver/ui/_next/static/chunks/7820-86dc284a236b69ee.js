"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7820],{70349:function(e,n,i){var t,a,r,o;i.d(n,{FR:function(){return S},UO:function(){return f},Xx:function(){return m},YM:function(){return c},YR:function(){return N},bh:function(){return d},by:function(){return v},d3:function(){return p},fk:function(){return u},ib:function(){return k},qI:function(){return h},qq:function(){return s},wW:function(){return l},xj:function(){return a}}),(r=t||(t={})).Github="GITHUB",r.Google="GOOGLE",(o=a||(a={})).Chat="CHAT",o.Completion="COMPLETION";let d={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetRegistrationToken"},selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"registrationToken"}}]}}]},l={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"ResetRegistrationToken"},selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"resetRegistrationToken"}}]}}]},u={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"MeQuery"},selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"me"},selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"authToken"}}]}}]}}]},s={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"ResetUserAuthToken"},selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"resetUserAuthToken"}}]}}]},k={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"CreateInvitation"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"email"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"String"}}}}],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"createInvitation"},arguments:[{kind:"Argument",name:{kind:"Name",value:"email"},value:{kind:"Variable",name:{kind:"Name",value:"email"}}}]}]}}]},m={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"ListInvitations"},selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"invitations"},selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"}},{kind:"Field",name:{kind:"Name",value:"email"}},{kind:"Field",name:{kind:"Name",value:"code"}},{kind:"Field",name:{kind:"Name",value:"createdAt"}}]}}]}}]},c={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"DeleteInvitation"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"id"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Int"}}}}],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"deleteInvitation"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"id"}}}]}]}}]},v={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"ListUsers"},selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"users"},selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"email"}},{kind:"Field",name:{kind:"Name",value:"isAdmin"}},{kind:"Field",name:{kind:"Name",value:"createdAt"}}]}}]}}]},f={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"tokenAuth"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"email"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"String"}}}},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"password"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"String"}}}}],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"tokenAuth"},arguments:[{kind:"Argument",name:{kind:"Name",value:"email"},value:{kind:"Variable",name:{kind:"Name",value:"email"}}},{kind:"Argument",name:{kind:"Name",value:"password"},value:{kind:"Variable",name:{kind:"Name",value:"password"}}}],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"accessToken"}},{kind:"Field",name:{kind:"Name",value:"refreshToken"}}]}}]}}]},N={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"register"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"email"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"String"}}}},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"password1"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"String"}}}},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"password2"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"String"}}}},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"invitationCode"}},type:{kind:"NamedType",name:{kind:"Name",value:"String"}}}],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"register"},arguments:[{kind:"Argument",name:{kind:"Name",value:"email"},value:{kind:"Variable",name:{kind:"Name",value:"email"}}},{kind:"Argument",name:{kind:"Name",value:"password1"},value:{kind:"Variable",name:{kind:"Name",value:"password1"}}},{kind:"Argument",name:{kind:"Name",value:"password2"},value:{kind:"Variable",name:{kind:"Name",value:"password2"}}},{kind:"Argument",name:{kind:"Name",value:"invitationCode"},value:{kind:"Variable",name:{kind:"Name",value:"invitationCode"}}}],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"accessToken"}},{kind:"Field",name:{kind:"Name",value:"refreshToken"}}]}}]}}]},p={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetWorkers"},selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"workers"},selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"kind"}},{kind:"Field",name:{kind:"Name",value:"name"}},{kind:"Field",name:{kind:"Name",value:"addr"}},{kind:"Field",name:{kind:"Name",value:"device"}},{kind:"Field",name:{kind:"Name",value:"arch"}},{kind:"Field",name:{kind:"Name",value:"cpuInfo"}},{kind:"Field",name:{kind:"Name",value:"cpuCount"}},{kind:"Field",name:{kind:"Name",value:"cudaDevices"}}]}}]}}]},S={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"refreshToken"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"refreshToken"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"String"}}}}],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"refreshToken"},arguments:[{kind:"Argument",name:{kind:"Name",value:"refreshToken"},value:{kind:"Variable",name:{kind:"Name",value:"refreshToken"}}}],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"accessToken"}},{kind:"Field",name:{kind:"Name",value:"refreshToken"}}]}}]}}]},h={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetIsAdminInitialized"},selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"isAdminInitialized"}}]}}]}},58835:function(e,n,i){i.d(n,{BX:function(){return r}});var t=i(70349);let a={"\n  query GetRegistrationToken {\n    registrationToken\n  }\n":t.bh,"\n  mutation ResetRegistrationToken {\n    resetRegistrationToken\n  }\n":t.wW,"\n  query MeQuery {\n    me {\n      authToken\n    }\n  }\n":t.fk,"\n  mutation ResetUserAuthToken {\n    resetUserAuthToken\n  }\n":t.qq,"\n  mutation CreateInvitation($email: String!) {\n    createInvitation(email: $email)\n  }\n":t.ib,"\n  query ListInvitations {\n    invitations {\n      id\n      email\n      code\n      createdAt\n    }\n  }\n":t.Xx,"\n  mutation DeleteInvitation($id: Int!) {\n    deleteInvitation(id: $id)\n  }\n":t.YM,"\n  query ListUsers {\n    users {\n      email\n      isAdmin\n      createdAt\n    }\n  }\n":t.by,"\n  mutation tokenAuth($email: String!, $password: String!) {\n    tokenAuth(email: $email, password: $password) {\n      accessToken\n      refreshToken\n    }\n  }\n":t.UO,"\n  mutation register(\n    $email: String!\n    $password1: String!\n    $password2: String!\n    $invitationCode: String\n  ) {\n    register(\n      email: $email\n      password1: $password1\n      password2: $password2\n      invitationCode: $invitationCode\n    ) {\n      accessToken\n      refreshToken\n    }\n  }\n":t.YR,"\n  query GetWorkers {\n    workers {\n      kind\n      name\n      addr\n      device\n      arch\n      cpuInfo\n      cpuCount\n      cudaDevices\n    }\n  }\n":t.d3,"\n  mutation refreshToken($refreshToken: String!) {\n    refreshToken(refreshToken: $refreshToken) {\n      accessToken\n      refreshToken\n    }\n  }\n":t.FR,"\n  query GetIsAdminInitialized {\n    isAdminInitialized\n  }\n":t.qI};function r(e){var n;return null!==(n=a[e])&&void 0!==n?n:{}}},58001:function(e,n,i){i.d(n,{Dp:function(){return T},Ho:function(){return g},QJ:function(){return A},Rn:function(){return p},av:function(){return w},bW:function(){return f},kP:function(){return F},pC:function(){return N},zq:function(){return D}});var t,a,r=i(57437),o=i(2265),d=i(24033),l=i(53771),u=i(99109),s=i(26566),k=i.n(s),m=i(58835),c=i(39311);(t=a||(a={}))[t.SignIn=0]="SignIn",t[t.SignOut=1]="SignOut",t[t.Refresh=2]="Refresh";let v="_tabby_auth",f=()=>{if((0,c.S_)()){let e=localStorage.getItem(v);if(!e)return null;try{return JSON.parse(e)}catch(e){}}return null},N=e=>{localStorage.setItem(v,JSON.stringify(e))},p=()=>{localStorage.removeItem(v)};function S(e,n){var i,t;let r=function(e,n){switch(n.type){case a.SignIn:case a.Refresh:return{status:"authenticated",data:n.data};case a.SignOut:return{status:"unauthenticated",data:null}}}(0,n);return e.status==r.status&&(i=e.data,t=r.data,(null==i?void 0:i.accessToken)===(null==t?void 0:t.accessToken)&&(null==i?void 0:i.refreshToken)===(null==t?void 0:t.refreshToken))?e:r}let h=o.createContext({}),T=(0,m.BX)("\n  mutation refreshToken($refreshToken: String!) {\n    refreshToken(refreshToken: $refreshToken) {\n      accessToken\n      refreshToken\n    }\n  }\n"),g=e=>{let{children:n}=e,[i]=k()(v,null),[t,d]=o.useReducer(S,{status:"loading",data:null});o.useEffect(()=>{(null==i?void 0:i.accessToken)&&(null==i?void 0:i.refreshToken)?d({type:a.Refresh,data:i}):d({type:a.SignOut})},[i]);let u=o.useMemo(()=>{var e,n;if((null==t?void 0:t.status)=="authenticated")try{let{sub:e,is_admin:n}=(0,l.o)(t.data.accessToken);return{data:{email:e,isAdmin:n,accessToken:t.data.accessToken},status:t.status}}catch(n){return console.error("jwt decode failed"),{status:null!==(e=null==t?void 0:t.status)&&void 0!==e?e:"loading",data:{email:"",isAdmin:!1,accessToken:t.data.accessToken}}}return{status:null!==(n=null==t?void 0:t.status)&&void 0!==n?n:"loading",data:null}},[t]);return(0,r.jsx)(h.Provider,{value:{authState:t,dispatch:d,session:u},children:n})};class y extends Error{constructor(){super("AuthProvider is missing. Please add the AuthProvider at root level")}}function b(){let e=o.useContext(h);if(!e)throw new y;return e}function D(){let{dispatch:e}=b();return async n=>(N({accessToken:n.accessToken,refreshToken:n.refreshToken}),e({type:a.SignIn,data:n}),!0)}function A(){let{dispatch:e}=b();return async()=>{p(),e({type:a.SignOut})}}function F(){let{session:e}=b();return e}let I=(0,m.BX)("\n  query GetIsAdminInitialized {\n    isAdminInitialized\n  }\n");function w(){let[{data:e}]=(0,u.aM)({query:I}),n=(0,d.useRouter)(),{data:i,status:t}=F();return o.useEffect(()=>{"loading"!==t&&"authenticated"!==t&&((null==e?void 0:e.isAdminInitialized)===!1?n.replace("/auth/signup?isAdmin=true"):"unauthenticated"===t&&n.replace("/auth/signin"))},[e,t]),i}},7820:function(e,n,i){i.d(n,{D:function(){return s},L:function(){return m}});var t,a=i(69166),r=i(53771),o=i(99109),d=i(18398),l=i(58001),u=i(68571);function s(e,n){var i;let[t,a]=(0,o.Db)(e),r=(null==n?void 0:n.form)?(i=n.form,e=>{let{graphQLErrors:n=[]}=e;for(let e of n)if(e.extensions&&e.extensions["validation-errors"]){let n=e.extensions["validation-errors"];for(let e of n.errors)i.setError(e.path,e)}else i.setError("root",e)}):void 0,d=async e=>{let i;try{let t=await a(e);if(null==t?void 0:t.error){r&&r(t.error),(null==n?void 0:n.onError)&&n.onError(t.error);return}i=null==t?void 0:t.data}catch(e){(null==n?void 0:n.onError)&&n.onError(e);return}return i&&(null==n?void 0:n.onCompleted)&&n.onCompleted(i),i};return d}let k=e=>Date.now()>1e3*e,m=new d.KU({url:"".concat(null!==(t=u.env.NEXT_PUBLIC_TABBY_SERVER_URL)&&void 0!==t?t:"","/graphql"),requestPolicy:"cache-and-network",exchanges:[d.HG,(0,a.M)(async e=>{let n=(0,l.bW)(),i=null==n?void 0:n.accessToken,t=null==n?void 0:n.refreshToken;return{addAuthToOperation:n=>i?e.appendHeaders(n,{Authorization:"Bearer ".concat(i)}):n,didAuthError:(e,n)=>401===e.response.status||e.graphQLErrors.some(e=>"Unauthorized"===e.extensions),willAuthError(e){let n=(0,l.bW)();if(i=null==n?void 0:n.accessToken,t=null==n?void 0:n.refreshToken,"mutation"===e.kind&&e.query.definitions.some(e=>{var n;return"OperationDefinition"===e.kind&&(null===(n=e.name)||void 0===n?void 0:n.value)&&["tokenAuth","registerUser"].includes(e.name.value)})||t&&"mutation"===e.kind&&e.query.definitions.some(e=>{var n;return"OperationDefinition"===e.kind&&(null==e?void 0:null===(n=e.name)||void 0===n?void 0:n.value)==="refreshToken"}))return!1;if(!i)return!0;try{let{exp:e}=(0,r.o)(i);return!e||k(e)}catch(e){return!0}},async refreshAuth(){if(t){var n;let a=await e.mutate(l.Dp,{refreshToken:t});(null===(n=a.data)||void 0===n?void 0:n.refreshToken)?(i=a.data.refreshToken.accessToken,t=a.data.refreshToken.refreshToken,(0,l.pC)({accessToken:i,refreshToken:t})):(0,l.Rn)()}else(0,l.Rn)()}}}),d.Ek]})},39311:function(e,n,i){i.d(n,{S_:function(){return u},aF:function(){return l},cn:function(){return o},x0:function(){return d}});var t=i(50348),a=i(28481),r=i(23986);function o(){for(var e=arguments.length,n=Array(e),i=0;i<e;i++)n[i]=arguments[i];return(0,r.m)((0,t.W)(n))}let d=(0,a.kP)("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",7);function l(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:50,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:/[ ,.:;\n，。：；]/;if(!e)return"";if(e.length<=n)return e;let t=e.slice(0,n),a=-1;for(let e=n-1;e>=0;e--)if(i.test(t[e])){a=e;break}return -1!==a&&(t=t.slice(0,a)),t+"..."}let u=()=>!0}}]);