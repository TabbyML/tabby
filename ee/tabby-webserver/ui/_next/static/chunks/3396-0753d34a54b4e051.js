"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3396],{80605:function(e,r,t){t.d(r,{UA:function(){return v},Uw:function(){return d},c7:function(){return l},jJ:function(){return c},o4:function(){return f},vN:function(){return a},xG:function(){return u}});var n=t(40055),i=t(43240);let o=(0,i.BX)("\n  query GetServerInfo {\n    serverInfo {\n      isAdminInitialized\n      isEmailConfigured\n      isChatEnabled\n      allowSelfSignup\n      isDemoMode\n      disablePasswordLogin\n    }\n  }\n"),s=()=>{let[{data:e}]=(0,n.aM)({query:o});return null==e?void 0:e.serverInfo},a=()=>{let[{fetching:e}]=(0,n.aM)({query:o});return e},u=()=>{var e;return null===(e=s())||void 0===e?void 0:e.isChatEnabled},l=()=>{var e;return null===(e=s())||void 0===e?void 0:e.isAdminInitialized},d=()=>{var e;return null===(e=s())||void 0===e?void 0:e.isEmailConfigured},c=()=>{var e;return null===(e=s())||void 0===e?void 0:e.allowSelfSignup},v=()=>{var e;return null===(e=s())||void 0===e?void 0:e.isDemoMode},f=()=>{var e;return null===(e=s())||void 0===e?void 0:e.disablePasswordLogin}},91302:function(e,r,t){t.d(r,{Dp:function(){return h},Ho:function(){return y},QJ:function(){return T},av:function(){return w},kP:function(){return I},zq:function(){return b}});var n,i,o=t(36164),s=t(3546),a=t(11978),u=t(24426),l=t.n(u),d=t(43240),c=t(80605),v=t(11634),f=t(66794);function p(e,r){var t,n;let o=function(e,r){switch(r.type){case i.SignIn:case i.Refresh:return{status:"authenticated",data:r.data};case i.SignOut:return{status:"unauthenticated",data:void 0}}}(0,r);return e.status==o.status&&(t=e.data,n=o.data,(null==t?void 0:t.accessToken)===(null==n?void 0:n.accessToken)&&(null==t?void 0:t.refreshToken)===(null==n?void 0:n.refreshToken))?e:o}(n=i||(i={}))[n.SignIn=0]="SignIn",n[n.SignOut=1]="SignOut",n[n.Refresh=2]="Refresh";let g=s.createContext({}),h=(0,d.BX)("\n  mutation refreshToken($refreshToken: String!) {\n    refreshToken(refreshToken: $refreshToken) {\n      accessToken\n      refreshToken\n    }\n  }\n"),m=(0,d.BX)("\n  mutation LogoutAllSessions {\n    logoutAllSessions\n  }\n"),y=e=>{let{children:r}=e,[t,n]=s.useState(!1),[a]=l()(f.nd,void 0),[u,d]=s.useReducer(p,{status:"loading",data:void 0});s.useEffect(()=>{(null==a?void 0:a.accessToken)&&(null==a?void 0:a.refreshToken)?d({type:i.SignIn,data:a}):d({type:i.SignOut}),n(!0)},[]),s.useEffect(()=>{!t||((null==a?void 0:a.accessToken)&&(null==a?void 0:a.refreshToken)?d({type:i.Refresh,data:a}):(null==a?void 0:a.accessToken)||(null==a?void 0:a.refreshToken)||d({type:i.SignOut}))},[a]);let c=s.useMemo(()=>{var e;return(null==u?void 0:u.status)=="authenticated"?{data:{accessToken:u.data.accessToken},status:u.status}:{status:null!==(e=null==u?void 0:u.status)&&void 0!==e?e:"loading",data:null}},[u]);return(0,o.jsx)(g.Provider,{value:{authState:u,dispatch:d,session:c},children:r})};class k extends Error{constructor(){super("AuthProvider is missing. Please add the AuthProvider at root level")}}function S(){let e=s.useContext(g);if(!e)throw new k;return e}function b(){let{dispatch:e}=S(),[r,t]=l()(f.nd,void 0);return async r=>(t({accessToken:r.accessToken,refreshToken:r.refreshToken}),e({type:i.SignIn,data:r}),!0)}function T(){let e=(0,v.Db)(m),{dispatch:r}=S(),[t,n]=l()(f.nd,void 0);return async()=>{await e(),n(void 0),r({type:i.SignOut})}}function I(){let{session:e}=S();return e}let A=["/auth/signin","/auth/signup","/auth/reset-password"];function w(){let e=(0,c.c7)(),r=(0,a.useRouter)(),t=(0,a.usePathname)(),n=(0,a.useSearchParams)(),{data:i,status:o}=I();return s.useEffect(()=>{if("loading"===o||"authenticated"===o||void 0===e)return;let i="/auth/signup"===t&&"true"===n.get("isAdmin");if(!i&&!e)return r.replace("/auth/signup?isAdmin=true");A.includes(t)||r.replace("/auth/signin")},[e,o]),i}},11634:function(e,r,t){t.d(r,{Db:function(){return p},Lp:function(){return h},zG:function(){return g}});var n=t(22365),i=t(28552),o=t(81013),s=t(17522),a=t(79716),u=t(74630),l=t(40055),d=t(44745),c=t(91302),v=t(70410),f=t(66794);function p(e,r){let[t,n]=(0,l.Db)(e),i=(null==r?void 0:r.form)?g(r.form):void 0,o=async(e,t)=>{let o;try{if(null==(o=await n(e,t))?void 0:o.error)i&&i(o.error),(null==r?void 0:r.onError)&&r.onError(o.error);else if(!(0,u.Z)(null==o?void 0:o.data)){var s;null==r||null===(s=r.onCompleted)||void 0===s||s.call(r,o.data)}}catch(e){(null==r?void 0:r.onError)&&r.onError(e);return}return o};return o}function g(e){return r=>{let{graphQLErrors:t=[]}=r;for(let r of t)if(r.extensions&&r.extensions["validation-errors"]){let t=r.extensions["validation-errors"];for(let r of t.errors)e.setError(r.path,r)}else(null==r?void 0:r.originalError)?e.setError("root",r.originalError):(null==r?void 0:r.message)&&e.setError("root",{message:r.message})}}let h=new d.KU({url:"/graphql",requestPolicy:"cache-and-network",exchanges:[(0,i.HG)({keys:{CompletionStats:()=>null,ServerInfo:()=>null,RepositorySearch:()=>null,RepositoryList:()=>null,RepositoryGrep:()=>null,GrepLine:()=>null,GrepFile:()=>null,GrepTextOrBase64:()=>null,GrepSubMatch:()=>null,GitReference:()=>null,MessageAttachment:()=>null,MessageAttachmentCode:()=>null,MessageAttachmentDoc:()=>null,NetworkSetting:()=>null,ContextInfo:()=>null,PageCreated:()=>null,PageContentCompleted:()=>null,PageSectionsCreated:()=>null,PageSectionContentCompleted:()=>null,PageSectionAttachmentCode:()=>null,PageSectionAttachmentDoc:()=>null,SectionAttachment:()=>null},resolvers:{Query:{invitations:(0,o.N)(),gitRepositories:(0,o.N)(),webCrawlerUrls:(0,o.N)(),integrations:(0,o.N)(),threads:(0,o.N)(),myThreads:(0,o.N)()}},updates:{Mutation:{deleteInvitation(e,r,t,n){e.deleteInvitation&&t.inspectFields("Query").filter(e=>"invitations"===e.fieldName).forEach(e=>{t.updateQuery({query:v.lE,variables:e.arguments},e=>{var t;return(null==e?void 0:null===(t=e.invitations)||void 0===t?void 0:t.edges)&&(e.invitations.edges=e.invitations.edges.filter(e=>e.node.id!==r.id)),e})})},deleteGitRepository(e,r,t,n){e.deleteGitRepository&&t.inspectFields("Query").filter(e=>"gitRepositories"===e.fieldName).forEach(e=>{t.updateQuery({query:v.S1,variables:e.arguments},e=>{var t;return(null==e?void 0:null===(t=e.gitRepositories)||void 0===t?void 0:t.edges)&&(e.gitRepositories.edges=e.gitRepositories.edges.filter(e=>e.node.id!==r.id)),e})})},deleteIntegration(e,r,t,n){e.deleteIntegration&&t.inspectFields("Query").filter(e=>"integrations"===e.fieldName).forEach(e=>{t.updateQuery({query:v.kb,variables:e.arguments},e=>((null==e?void 0:e.integrations)&&(e.integrations.edges=e.integrations.edges.filter(e=>e.node.id!==r.id)),e))})},createIntegration(e,r,t){let n="Query";t.inspectFields(n).filter(e=>{var t,n,i;return"integrations"===e.fieldName&&!!(null===(t=e.arguments)||void 0===t?void 0:t.kind)&&(null===(n=e.arguments)||void 0===n?void 0:n.kind)===(null==r?void 0:null===(i=r.input)||void 0===i?void 0:i.kind)}).forEach(e=>{t.invalidate(n,e.fieldName,e.arguments)})},upsertUserGroupMembership(e,r,t,n){let{userGroupId:i,userId:o,isGroupAdmin:s}=r.input,{user:a,isInsert:u}=n.variables.extraParams||{};e.upsertUserGroupMembership&&t.updateQuery({query:v.gI},e=>((null==e?void 0:e.userGroups)&&(e.userGroups=e.userGroups.map(e=>{if(e.id!==i)return e;let r=[...e.members];if(u){let e=new Date().toISOString();r.push({user:{...a,__typename:"UserSecured"},isGroupAdmin:s,createdAt:e,updatedAt:e,__typename:"UserGroupMembership"})}else r=r.map(e=>e.user.id!==o?e:{...e,isGroupAdmin:s});return{...e,members:r}})),e))},deleteUserGroupMembership(e,r,t,n){let{userGroupId:i,userId:o}=r;e.deleteUserGroupMembership&&t.updateQuery({query:v.gI},e=>((null==e?void 0:e.userGroups)&&(e.userGroups=e.userGroups.map(e=>{if(e.id!==i)return e;let r=[...e.members].filter(e=>e.user.id!==o);return{...e,members:r}})),e))},grantSourceIdReadAccess(e,r,t,n){if(e.grantSourceIdReadAccess){let{sourceId:e}=r;t.inspectFields("Query").filter(r=>{var t;return"sourceIdAccessPolicies"===r.fieldName&&(null===(t=r.arguments)||void 0===t?void 0:t.sourceId)===e}).forEach(e=>{t.updateQuery({query:v.hA,variables:e.arguments},e=>{var t;if(null==e?void 0:null===(t=e.sourceIdAccessPolicies)||void 0===t?void 0:t.read){let{userGroupName:t}=n.variables.extraParams||{};e.sourceIdAccessPolicies.read=[...e.sourceIdAccessPolicies.read,{__typename:"UserGroup",id:r.userGroupId,name:t}]}return e})})}},revokeSourceIdReadAccess(e,r,t,n){if(e.revokeSourceIdReadAccess){let{userGroupId:e,sourceId:n}=r;t.inspectFields("Query").filter(e=>{var r;return"sourceIdAccessPolicies"===e.fieldName&&(null===(r=e.arguments)||void 0===r?void 0:r.sourceId)===n}).forEach(r=>{t.updateQuery({query:v.hA,variables:r.arguments},r=>{var t,i;return(null==r?void 0:null===(t=r.sourceIdAccessPolicies)||void 0===t?void 0:t.sourceId)===n&&(null==r?void 0:null===(i=r.sourceIdAccessPolicies)||void 0===i?void 0:i.read)&&(r.sourceIdAccessPolicies.read=r.sourceIdAccessPolicies.read.filter(r=>r.id!==e)),r})})}},deleteThread(e,r,t,n){e.deleteThread&&(t.inspectFields("Query").filter(e=>{var r;return"threads"===e.fieldName&&!(null===(r=e.arguments)||void 0===r?void 0:r.ids)}).forEach(e=>{t.updateQuery({query:v.XL,variables:e.arguments},e=>((null==e?void 0:e.threads)&&(e.threads.edges=e.threads.edges.filter(e=>e.node.id!==r.id)),e))}),t.inspectFields("Query").filter(e=>"myThreads"===e.fieldName).forEach(e=>{t.updateQuery({query:v.rm,variables:e.arguments},e=>((null==e?void 0:e.myThreads)&&(e.myThreads.edges=e.myThreads.edges.filter(e=>e.node.id!==r.id)),e))}))},setThreadPersisted(e,r,t,n){if(e.setThreadPersisted){let e="Query";t.inspectFields(e).filter(e=>{var r,t;return"threads"===e.fieldName&&!(null===(r=e.arguments)||void 0===r?void 0:r.ids)&&!!(null===(t=e.arguments)||void 0===t?void 0:t.before)}).forEach(r=>{t.invalidate(e,r.fieldName,r.arguments)})}},markNotificationsRead(e,r,t){e.markNotificationsRead&&t.inspectFields("Query").filter(e=>"notifications"===e.fieldName).forEach(e=>{t.updateQuery({query:v.g0,variables:e.arguments},e=>{if(null==e?void 0:e.notifications){let t=!r.notificationId;e.notifications=e.notifications.map(e=>t?{...e,read:!0}:e.id===r.notificationId?{...e,read:!0}:e)}return e})})},deletePageSection(e,r,t){e.deletePageSection&&t.inspectFields("Query").filter(e=>"pageSections"===e.fieldName).forEach(e=>{t.updateQuery({query:v.bP,variables:e.arguments},e=>((null==e?void 0:e.pageSections)&&(e.pageSections.edges=e.pageSections.edges.filter(e=>e.node.id!==r.id)),e))})}}},optimistic:{upsertUserGroupMembership:()=>!0,deleteUserGroupMembership:()=>!0,grantSourceIdReadAccess:()=>!0,revokeSourceIdReadAccess:()=>!0}}),(0,n.M)(async e=>{let r=(0,f.bW)(),t=null==r?void 0:r.accessToken,n=null==r?void 0:r.refreshToken;return{addAuthToOperation(r){let i=(0,f.bW)(),o=(0,f.jW)();if(t=null==i?void 0:i.accessToken,n=null==i?void 0:i.refreshToken,t)return e.appendHeaders(r,{Authorization:"Bearer ".concat(t)});if(o){let t={Authorization:"Bearer ".concat(o.authorization),...o.headers};return e.appendHeaders(r,t)}return r},didAuthError(e,r){let t=e.graphQLErrors.some(e=>{var r;return(null==e?void 0:null===(r=e.extensions)||void 0===r?void 0:r.code)==="UNAUTHORIZED"});return t&&f.gN.clearAccessToken(),t},willAuthError(e){let r=(0,f.bW)(),i=(0,f.jW)();if(t=null==r?void 0:r.accessToken,n=null==r?void 0:r.refreshToken,"query"===e.kind&&e.query.definitions.some(e=>{var r;return"OperationDefinition"===e.kind&&(null===(r=e.name)||void 0===r?void 0:r.value)&&["GetServerInfo"].includes(e.name.value)})||"mutation"===e.kind&&e.query.definitions.some(e=>{var r;return"OperationDefinition"===e.kind&&(null===(r=e.name)||void 0===r?void 0:r.value)&&["tokenAuth","register"].includes(e.name.value)})||n&&"mutation"===e.kind&&e.query.definitions.some(e=>{var r;return"OperationDefinition"===e.kind&&(null==e?void 0:null===(r=e.name)||void 0===r?void 0:r.value)==="refreshToken"}))return!1;if(t)try{let{exp:e}=(0,a.o)(t);return(0,f.pw)(e)}catch(e){return!0}else if(i)return!(null==i?void 0:i.authorization);else return f.gN.clearAccessToken(),!0},refreshAuth:async()=>f.gN.refreshToken(async()=>{var r;let t=null===(r=(0,f.bW)())||void 0===r?void 0:r.refreshToken;if(t)return e.mutate(c.Dp,{refreshToken:t}).then(e=>{var r;return null==e?void 0:null===(r=e.data)||void 0===r?void 0:r.refreshToken})})}}),(0,d.Dk)({onError(e){e.message.startsWith("[GraphQL]")&&(e.message=e.message.replace("[GraphQL]","").trim())}}),d.Ek,(0,d.pV)({forwardSubscription(e,r){var t,n,i;let o=null!==(i=null===(n=r.context.fetchOptions)||void 0===n?void 0:null===(t=n.headers)||void 0===t?void 0:t.Authorization)&&void 0!==i?i:"",a=window.location.protocol,u=window.location.host,l=(0,s.eI)({url:"".concat("https:"===a?"wss:":"ws:","//").concat(u,"/subscriptions"),connectionParams:{authorization:o}}),d={...e,query:e.query||""};return{subscribe(e){let r=l.subscribe(d,e);return{unsubscribe:r}}}}})]})},66794:function(e,r,t){t.d(r,{bW:function(){return u},gN:function(){return g},jW:function(){return f},nd:function(){return s},pw:function(){return c},zr:function(){return p}});var n=t(79716),i=t(74630),o=t(73492);let s="_tabby_auth",a="_tabby_chat_sdk_fetcher_options",u=()=>{if((0,o.S_)()){let e=localStorage.getItem(s);if(e)try{return JSON.parse(e)}catch(e){}}},l=e=>{localStorage.setItem(s,JSON.stringify(e))},d=()=>{localStorage.removeItem(s),window.dispatchEvent(new StorageEvent("storage",{storageArea:window.localStorage,url:window.location.href,key:s}))},c=e=>!!(0,i.Z)(e)||Date.now()>1e3*e,v=e=>!(0,i.Z)(e)&&Date.now()-1e3*e<6e4,f=()=>{try{let e=sessionStorage.getItem(a);if(!e)return;return JSON.parse(e)}catch(e){return}},p=e=>{if(e)try{sessionStorage.setItem(a,JSON.stringify(e))}catch(e){sessionStorage.removeItem(a)}},g=new class{clearAccessToken(){let e=u();e&&l({...e,accessToken:""})}async refreshToken(e){try{var r;if(void 0===(null===(r=navigator)||void 0===r?void 0:r.locks))throw console.error("The Web Locks API is not supported in your browser. Please upgrade to a newer browser version."),Error();await navigator.locks.request("_tabby_auth_lock",async()=>{let r;let t=u(),i=null==t?void 0:t.accessToken,o=null==t?void 0:t.refreshToken;if(i){let{iat:o}=(0,n.o)(i);r=v(o)?t:await e()}else o&&(r=await e());r?l(r):d()})}catch(e){d()}}}}}]);